# =============================================================
# RAG Expert Chatbot — Docker Compose (Production)
# Usage : docker compose up -d
# =============================================================

version: '3.9'

services:

  # ── Backend FastAPI ─────────────────────────────────────────
    backend:
        build:
              context: ../backend
                    dockerfile: Dockerfile
                        container_name: rag-backend
                            ports:
                                  - "${BACKEND_PORT:-8000}:8000"
                                      environment:
                                            - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
                                                  - OLLAMA_BASE_URL=http://host.docker.internal:11434
                                                        - GROQ_API_KEY=${GROQ_API_KEY:-}
                                                              - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
                                                                    - QDRANT_HOST=qdrant
                                                                          - QDRANT_PORT=6333
                                                                                - COLLECTION_NAME=${COLLECTION_NAME:-rag_expert}
                                                                                      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-password123}@postgres:5432/${POSTGRES_DB:-chatbot_db}
                                                                                            - REDIS_URL=redis://redis:6379/0
                                                                                                  - KEYCLOAK_URL=http://keycloak:8080
                                                                                                        - KEYCLOAK_REALM=${KEYCLOAK_REALM:-chatbot-realm}
                                                                                                              - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-chatbot-app}
                                                                                                                    - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET:-secret}
                                                                                                                          - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
                                                                                                                                - CORS_ORIGINS=http://localhost:${FRONTEND_PORT:-3000}
                                                                                                                                      - LOG_LEVEL=${LOG_LEVEL:-INFO}
                                                                                                                                            - DOCUMENTS_FOLDER=/app/documents
                                                                                                                                                  - SHAREPOINT_ENABLED=${SHAREPOINT_ENABLED:-false}
                                                                                                                                                      volumes:
                                                                                                                                                            - ../documents:/app/documents
                                                                                                                                                                depends_on:
                                                                                                                                                                      postgres:
                                                                                                                                                                              condition: service_healthy
                                                                                                                                                                                    redis:
                                                                                                                                                                                            condition: service_healthy
                                                                                                                                                                                                  qdrant:
                                                                                                                                                                                                          condition: service_started
                                                                                                                                                                                                              restart: unless-stopped
                                                                                                                                                                                                                  networks:
                                                                                                                                                                                                                        - rag-network
                                                                                                                                                                                                                            healthcheck:
                                                                                                                                                                                                                                  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
                                                                                                                                                                                                                                        interval: 30s
                                                                                                                                                                                                                                              timeout: 10s
                                                                                                                                                                                                                                                    retries: 3
                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                      # ── Frontend React ──────────────────────────────────────────
                                                                                                                                                                                                                                                        frontend:
                                                                                                                                                                                                                                                            build:
                                                                                                                                                                                                                                                                  context: ../frontend
                                                                                                                                                                                                                                                                        dockerfile: Dockerfile
                                                                                                                                                                                                                                                                              args:
                                                                                                                                                                                                                                                                                      - VITE_API_URL=http://localhost:${BACKEND_PORT:-8000}
                                                                                                                                                                                                                                                                                              - VITE_KEYCLOAK_URL=http://localhost:${KEYCLOAK_PORT:-8080}
                                                                                                                                                                                                                                                                                                      - VITE_KEYCLOAK_REALM=${KEYCLOAK_REALM:-chatbot-realm}
                                                                                                                                                                                                                                                                                                              - VITE_KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID:-chatbot-app}
                                                                                                                                                                                                                                                                                                                  container_name: rag-frontend
                                                                                                                                                                                                                                                                                                                      ports:
                                                                                                                                                                                                                                                                                                                            - "${FRONTEND_PORT:-3000}:80"
                                                                                                                                                                                                                                                                                                                                depends_on:
                                                                                                                                                                                                                                                                                                                                      - backend
                                                                                                                                                                                                                                                                                                                                          restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                              networks:
                                                                                                                                                                                                                                                                                                                                                    - rag-network
                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                      # ── Base vectorielle Qdrant ─────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                        qdrant:
                                                                                                                                                                                                                                                                                                                                                            image: qdrant/qdrant:latest
                                                                                                                                                                                                                                                                                                                                                                container_name: rag-qdrant
                                                                                                                                                                                                                                                                                                                                                                    ports:
                                                                                                                                                                                                                                                                                                                                                                          - "6333:6333"
                                                                                                                                                                                                                                                                                                                                                                                - "6334:6334"
                                                                                                                                                                                                                                                                                                                                                                                    volumes:
                                                                                                                                                                                                                                                                                                                                                                                          - qdrant_storage:/qdrant/storage
                                                                                                                                                                                                                                                                                                                                                                                              restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                  networks:
                                                                                                                                                                                                                                                                                                                                                                                                        - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                            environment:
                                                                                                                                                                                                                                                                                                                                                                                                                  - QDRANT__SERVICE__HTTP_PORT=6333
                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                    # ── Base de données PostgreSQL ──────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                      postgres:
                                                                                                                                                                                                                                                                                                                                                                                                                          image: postgres:16-alpine
                                                                                                                                                                                                                                                                                                                                                                                                                              container_name: rag-postgres
                                                                                                                                                                                                                                                                                                                                                                                                                                  environment:
                                                                                                                                                                                                                                                                                                                                                                                                                                        POSTGRES_DB: ${POSTGRES_DB:-chatbot_db}
                                                                                                                                                                                                                                                                                                                                                                                                                                              POSTGRES_USER: ${POSTGRES_USER:-admin}
                                                                                                                                                                                                                                                                                                                                                                                                                                                    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password123}
                                                                                                                                                                                                                                                                                                                                                                                                                                                        volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                              - postgres_data:/var/lib/postgresql/data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      healthcheck:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-chatbot_db}"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  interval: 10s
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        timeout: 5s
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              retries: 5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ── Cache Redis ─────────────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  redis:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      image: redis:7-alpine
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          container_name: rag-redis
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - redis_data:/data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          healthcheck:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                test: ["CMD", "redis-cli", "ping"]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      interval: 10s
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            timeout: 3s
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  retries: 3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # ── SSO Keycloak ────────────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      keycloak:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          image: quay.io/keycloak/keycloak:23.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              container_name: rag-keycloak
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  command: start-dev --import-realm
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      environment:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:-admin}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        KC_DB: postgres
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              KC_DB_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-chatbot_db}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    KC_DB_USERNAME: ${POSTGRES_USER:-admin}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-password123}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                KC_HOSTNAME_STRICT: "false"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      KC_HTTP_ENABLED: "true"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ports:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - "${KEYCLOAK_PORT:-8080}:8080"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              depends_on:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    postgres:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            condition: service_healthy
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ── Worker d'ingestion ──────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ingestion-worker:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  build:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        context: ../backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              dockerfile: Dockerfile.worker
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  container_name: rag-ingestion-worker
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      command: python -m ingestion.pipeline --watch
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          environment:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - QDRANT_HOST=qdrant
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - QDRANT_PORT=6333
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - OLLAMA_BASE_URL=http://host.docker.internal:11434
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - DOCUMENTS_FOLDER=/app/documents
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - REDIS_URL=redis://redis:6379/0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - ../documents:/app/documents
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      depends_on:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - qdrant
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - redis
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # ── Teams Bot (optionnel) ────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    teams-bot:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        build:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              context: ../teams-bot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    dockerfile: Dockerfile
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        container_name: rag-teams-bot
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ports:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - "3978:3978"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      environment:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - TEAMS_APP_ID=${TEAMS_APP_ID:-}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - TEAMS_APP_PASSWORD=${TEAMS_APP_PASSWORD:-}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - BACKEND_URL=http://backend:8000
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            depends_on:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    profiles:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - teams
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ── Monitoring : Prometheus ──────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              prometheus:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  image: prom/prometheus:latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      container_name: rag-prometheus
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ports:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - "9090:9090"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - prometheus_data:/prometheus
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    command:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - '--config.file=/etc/prometheus/prometheus.yml'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - '--storage.tsdb.retention.time=30d'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # ── Monitoring : Grafana ─────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  grafana:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      image: grafana/grafana:latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          container_name: rag-grafana
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ports:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - "${GRAFANA_PORT:-3001}:3000"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        environment:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - GF_USERS_ALLOW_SIGN_UP=false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - grafana_data:/var/lib/grafana
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - ./grafana/datasources:/etc/grafana/provisioning/datasources
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    depends_on:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - prometheus
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              restart: unless-stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - rag-network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # ── Volumes persistants ─────────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        volumes:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          qdrant_storage:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              driver: local
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                postgres_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    driver: local
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      redis_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          driver: local
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            prometheus_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                driver: local
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  grafana_data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      driver: local
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # ── Réseau interne ──────────────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      networks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        rag-network:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            driver: bridge
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                name: rag-expert-network
