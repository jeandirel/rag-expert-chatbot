name: CI - Tests & Quality

on:
  push:
      branches: [ main, develop, "feature/**" ]
        pull_request:
            branches: [ main, develop ]

            env:
              PYTHON_VERSION: "3.11"
                NODE_VERSION: "20"

                jobs:

                  backend-tests:
                      name: Backend Tests (Python)
                          runs-on: ubuntu-latest

                              services:
                                    postgres:
                                            image: postgres:16-alpine
                                                    env:
                                                              POSTGRES_DB: chatbot_test
                                                                        POSTGRES_USER: admin
                                                                                  POSTGRES_PASSWORD: password123
                                                                                          options: >-
                                                                                                    --health-cmd pg_isready
                                                                                                              --health-interval 10s
                                                                                                                        --health-timeout 5s
                                                                                                                                  --health-retries 5
                                                                                                                                          ports:
                                                                                                                                                    - 5432:5432
                                                                                                                                                    
                                                                                                                                                          redis:
                                                                                                                                                                  image: redis:7-alpine
                                                                                                                                                                          options: >-
                                                                                                                                                                                    --health-cmd "redis-cli ping"
                                                                                                                                                                                              --health-interval 10s
                                                                                                                                                                                                        --health-timeout 5s
                                                                                                                                                                                                                  --health-retries 3
                                                                                                                                                                                                                          ports:
                                                                                                                                                                                                                                    - 6379:6379
                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                          qdrant:
                                                                                                                                                                                                                                                  image: qdrant/qdrant:latest
                                                                                                                                                                                                                                                          ports:
                                                                                                                                                                                                                                                                    - 6333:6333
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                        steps:
                                                                                                                                                                                                                                                                              - name: Checkout code
                                                                                                                                                                                                                                                                                      uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                            - name: Setup Python
                                                                                                                                                                                                                                                                                                    uses: actions/setup-python@v5
                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                      python-version: ${{ env.PYTHON_VERSION }}
                                                                                                                                                                                                                                                                                                                                cache: pip
                                                                                                                                                                                                                                                                                                                                          cache-dependency-path: backend/requirements.txt
                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                - name: Install dependencies
                                                                                                                                                                                                                                                                                                                                                        working-directory: backend
                                                                                                                                                                                                                                                                                                                                                                run: |
                                                                                                                                                                                                                                                                                                                                                                          pip install --upgrade pip
                                                                                                                                                                                                                                                                                                                                                                                    pip install -r requirements.txt
                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                          - name: Lint with ruff
                                                                                                                                                                                                                                                                                                                                                                                                  working-directory: backend
                                                                                                                                                                                                                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                                                                                                                                                                                                                    pip install ruff
                                                                                                                                                                                                                                                                                                                                                                                                                              ruff check app/ ingestion/
                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Type check with mypy
                                                                                                                                                                                                                                                                                                                                                                                                                                            working-directory: backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                              pip install mypy
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        mypy app/ --ignore-missing-imports --no-strict-optional
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Run unit tests
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      working-directory: backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        DATABASE_URL: postgresql+asyncpg://admin:password123@localhost:5432/chatbot_test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  REDIS_URL: redis://localhost:6379/0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            QDRANT_HOST: localhost
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      QDRANT_PORT: "6333"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                LLM_PROVIDER: "mock"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          SECRET_KEY: test-secret-key-for-ci-only
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=term
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Run integration tests
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          working-directory: backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            DATABASE_URL: postgresql+asyncpg://admin:password123@localhost:5432/chatbot_test
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      REDIS_URL: redis://localhost:6379/0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                QDRANT_HOST: localhost
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          QDRANT_PORT: "6333"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    LLM_PROVIDER: "mock"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              SECRET_KEY: test-secret-key-for-ci-only
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pytest tests/integration/ -v
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Upload coverage
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              uses: codecov/codecov-action@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                file: backend/coverage.xml
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          fail_ci_if_error: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            frontend-tests:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                name: Frontend Tests (React)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Checkout code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Setup Node.js
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    uses: actions/setup-node@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      node-version: ${{ env.NODE_VERSION }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cache: npm
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          cache-dependency-path: frontend/package-lock.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - name: Install dependencies
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        working-directory: frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run: npm ci
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Lint
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              working-directory: frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: npm run lint
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Type check
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    working-directory: frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run: npm run type-check
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Run tests
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          working-directory: frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  run: npm test -- --coverage --watchAll=false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Build
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                working-directory: frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run: npm run build
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          docker-build:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              name: Docker Build Check
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      needs: [backend-tests, frontend-tests]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - name: Checkout code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Set up Docker Buildx
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      uses: docker/setup-buildx-action@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Build backend image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    uses: docker/build-push-action@v5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      context: ./backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                push: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          tags: rag-backend:ci-${{ github.sha }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cache-from: type=gha
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              cache-to: type=gha,mode=max
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Build frontend image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            uses: docker/build-push-action@v5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              context: ./frontend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        push: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  tags: rag-frontend:ci-${{ github.sha }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cache-from: type=gha
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      cache-to: type=gha,mode=max
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        security-scan:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            name: Security Scan
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - name: Checkout code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Run Trivy vulnerability scanner
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                uses: aquasecurity/trivy-action@master
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  scan-type: fs
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            scan-ref: .
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ignore-unfixed: true
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                severity: CRITICAL,HIGH
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Check Python dependencies
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              working-directory: backend
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pip install safety
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          safety check -r requirements.txt --ignore 70612
